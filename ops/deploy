#!/bin/bash

# Example usage: ./deploy production
# cd into the ops directory before attempting to run this script

APP_VERSION=$(date +%s)
ENVIRONMENT=$1
TAG="$ENVIRONMENT-$APP_VERSION"
echo "Deploying $TAG"

cd ..
timeout 600 docker build --platform linux/amd64 -t $TAG -f Dockerfile.production .
if [ $? -eq 124 ]; then
  echo "Error: Docker build timed out after 10 minutes"
  exit 1
fi
cd -

timeout 10 doctl registry login
if [ $? -eq 124 ]; then
  echo "Error: Registry login timed out after 10 seconds"
  exit 1
fi

docker tag $TAG registry.digitalocean.com/saturnci/saturnci:$TAG

timeout 600 docker push registry.digitalocean.com/saturnci/saturnci:$TAG
if [ $? -eq 124 ]; then
  echo "Error: Docker push timed out after 10 minutes"
  exit 1
fi

timeout 60 ./apply $ENVIRONMENT $TAG
if [ $? -eq 124 ]; then
  echo "Error: Kubectl apply timed out after 1 minute"
  exit 1
fi
